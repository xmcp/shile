<!DOCTYPE html>
<%!
    import  os
    import mimetypes
    def urllike(name):
        out=''
        for a in name:
            out+=hex(ord(a))[2:]
        return out
    def origin(name):
        out=''
        for now in range(0,len(name),2):
            out+=chr(int(name[now:now+2],16))
        return out
%>
<html>
<head lang="zh">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="http://libs.useso.com/js/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="http://libs.useso.com/js/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://libs.useso.com/js/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <title>Shile</title>
    <script>
        function urllike(name) {
            var out=''
            for(var now=0;now<name.length;now++)
                out+=name.charCodeAt(now).toString(16)
            return out
        }
        function cmdcallback(e,func) {
            var keynum
            if(window.event) keynum=e.keyCode //IE
            else keynum=e.which
            if(keynum==13) //enter
                func()
            return true
        }
        function redirect() {
            window.location.assign('/view/'+urllike(document.getElementById('new_pathname').value))
        }
        function down(name) {
                window.open('/down/${urllikes+"2f"}'+urllike(name))
        }
        function del(name) {
            if(confirm('确定删除 '+name+' 吗？'))
                window.location.assign('/delete/${urllikes+"2f"}'+urllike(name))
        }
        function ren(name) {
            newname=prompt('为 '+name+' 输入新的文件名：')
            if(newname!=''&&newname!=null)
                window.location.assign('/rename/${urllikes}/'+urllike(name)+'/'+urllike(newname))
        }
        function move(name) {
            newpath=prompt('将 '+name+' 移动到：')
            if(newpath!=''&&newpath!=null) {
                window.location.assign('/move/${urllikes}/'+urllike(name)+'/'+urllike(newpath))
            }
        }
        function newfolder() {
            n=prompt('新目录名：')
            if(n!=''&&n!=null)
                window.location.assign('/newfolder/${urllikes}/'+urllike(n))
        }
    </script>
</head>
<body><div class="container">
    <div class="navbar navbar-default" role="navigation">
        <span>
            <a href="#" class="navbar-brand dropdown-toggle" id="locations-dropdown" data-toggle="dropdown">
                <span class="glyphicon glyphicon-hdd"></span>&nbsp;Shile
                <span class="caret"></span>
            </a>
            <ul class="dropdown-menu" role="menu" aria-labelledby="location-dropdown">
                <li role="presentation">
                    <a role="menuitem" tabindex="-1" href="/">您的主页</a>
                </li>
                <li role="presentation">
                    <a role="menuitem" tabindex="-1" href="/view/${urllike(serverpath)}">Shile目录</a>
                </li>
                <li role="presentation">
                    <a role="menuitem" tabindex="-1" href="/view/${urllike(serverpath+'/public')}">公用目录</a>
                </li>
                <li role="presentation">
                    <a role="menuitem" tabindex="-1" href="/view/2f">整个磁盘</a>
                </li>
            </ul>
        </span>
        &nbsp;
        <button type="button" class="btn btn-default navbar-btn" onclick="window.location.assign('/logout')">
            注销
        </button>
        <div class="navbar-form navbar-right" style="margin-right: 0px">
            <div class="form-group">
                <input id="new_pathname" type="text" value="${origins}" class="form-control" autocomplete="on" onkeypress="cmdcallback(event,redirect)" style="width: 300px" placeholder="目录名">
            </div>
            <button type="button" onclick="redirect()" class="btn btn-primary">进入</button>
        </div>
    </div>
    <div class="page-header"><h3>
        <ol class="breadcrumb">
            % if (origins+'/')[0]=='/':
                <li><a href="/view/2f">
                    <span class="glyphicon glyphicon-hdd"></span>
                </a></li>&nbsp;
            % endif
            <%
                paths=[a+'/' for a in origins.split('/')]
            %>
            % for l in range(len(paths)):
                % if paths[l]!='/':
                    <li>
                        <a href="/view/${urllike(''.join(paths[:l+1]))}">${paths[l][:-1]}</a>
                    </li>
                % endif
            % endfor
        </ol>
    </h3></div>
    <table class="table table-hover">
        <thead>
            <tr>
                <th>文件名</th>
                <th style="text-align: right">类型</th>
                <th style="text-align: right">大小</th>
                <th style="text-align: right">操作</th>
            </tr>
        </thead>
        <tbody>
            % for f in files:
                <tr>
                    <td><a href="/view/${urllikes+'2f'+urllike(f)}">
                         % if os.path.isdir(origins+'/'+f):
                            <span class="glyphicon glyphicon-folder-open"></span>
                        % else:
                            <span class="glyphicon glyphicon-file" style="color: #474"></span>
                        % endif
                        &nbsp;${f}
                    </a></td>
                    <td style="text-align: right">
                        % if os.path.isfile(origins+'/'+f):
                            <% mime=mimetypes.guess_type(f)[0] %>
                            ${mime if mime else 'Unknown'}
                        % else:
                            目录
                        % endif
                    </td>
                    <td style="text-align: right">
                        % if os.path.isfile(origins+'/'+f):
                            <% s=os.path.getsize(origins+'/'+f) %>
                            ${s//1000000}M&nbsp;
                            ${s//1000%1000}K&nbsp;
                            ${s%1000}B
                        % else:
                            <%
                                subs=0
                                for a in os.walk(origins+'/'+f):
                                    subs+=len(a[2])
                                    if subs>100:
                                        subs='99+'
                                        break
                            %>
                            <b>${subs}</b>&nbsp;项
                        % endif
                    </td>
                    <td style="text-align: right">
                        % if os.path.isfile(origins+'/'+f):
                            <a href="#" onclick="down('${f}')">
                                <span class="glyphicon glyphicon-save"></span>
                            </a>&nbsp;
                            <a href="/compose/${urllikes+urllike('/'+f)}" target="_blank">
                                <span class="glyphicon glyphicon-edit"></span>
                            </a>&nbsp;
                        % endif
                        <a href="#" onclick="move('${f}')">
                            <span class="glyphicon glyphicon-move"></span>
                        </a>&nbsp;
                        <a href="#" onclick="del('${f}')">
                            <span class="glyphicon glyphicon-trash"></span>
                        </a>&nbsp;
                        <a href="#" onclick="ren('${f}')">
                            <span class="glyphicon glyphicon-pencil"></span>
                        </a>
                    </td>
                </tr>
            % endfor
        </tbody>
    </table>
    % if len(files)==0:
        <div class="alert alert-info">
            <span class="glyphicon glyphicon-inbox"></span>
            &nbsp;这个目录里什么都没有
        </div>
    % endif
    <br />
    <div class="btn-group btn-group-justified">
        <button class="btn btn-success" onclick="newfolder()" style="width:25%" role="button">
            <span class="glyphicon glyphicon-folder-open"></span>
            &nbsp;新建目录
        </button>
        <button class="btn btn-success" data-toggle="modal" data-target="#newfile-modal" style="width:25%" role="button">
            <span class="glyphicon glyphicon-pencil"></span>
            &nbsp;新建文件
        </button>
        <button class="btn btn-primary" data-toggle="modal" data-target="#upload-modal" style="width: 50%;" role="button">
            <span class="glyphicon glyphicon-cloud-upload"></span>
            &nbsp;上传文件
        </button>
    </div>
    <br />
    <!-- modals -->
    <!-- upload file -->
    <div class="modal fade" id="upload-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">上传文件</h4>
                </div>
                <div class="modal-body">
                    <form action="/upload" method="post" enctype="multipart/form-data">
                        <div class="input-group">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-paperclip"></span></span>
                            <input type="hidden" name="path" value="${urllikes}">
                            <input type="file" name="upfile" class="form-control">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" type="submit">上传</button>
                            </span>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- new file -->
    <div class="modal fade" id="newfile-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                    <h4 class="modal-title">新建文件</h4>
                </div>
                <div class="modal-body">
                    <form action="/newfile" method="post">
                        <input type="hidden" name="path" value="${urllikes}">
                        <div class="input-group">
                            <span class="input-group-addon"><span class="glyphicon glyphicon-file"></span></span>
                            <input type="text" name="filename" class="form-control" placeholder="文件名">
                            <span class="input-group-btn">
                                <button class="btn btn-primary" tabindex="-1" type="submit">保存</button>
                            </span>
                        </div>
                        <br />
                        <textarea name="text" class="form-control" style="width: 100%; height:300px;"></textarea>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- modal end -->
</div></body>
</html>